---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
plot(cars)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

```{r}
source("load.R")
library(ggplot2)
library(patchwork)

stats.SCIA.all <- load.SCIA.metadata()
stats.SCIA.modern <- stats.SCIA.all |> filter(last_year > 2010)
stats.SCIA <- stats.SCIA.modern
stats.DPC <- load.DPC.metadata()
ita <- load.italy()
```

```{r}
stats.pairs <- st_join(stats.DPC, stats.SCIA, join = st_is_within_distance, dist = units::set_units(10, "m"), left = FALSE)
```

```{r}
p1 <- ggplot() +
  geom_sf(data = ita, fill = NA) +
  geom_sf(data = stats.pairs, mapping = aes(color = N))

p2 <- ggplot() +
  geom_sf(data = ita, fill = NA) +
  geom_sf(data = stats.SCIA)

p1 + p2
```

```{r}
stats.nearest <- st_join(stats.DPC, stats.SCIA |> filter(last_year > 2010), join = st_nearest_feature)
```

```{r}
library(spData)
nz_agg <- st_join(nz, nz_height, join = st_intersects) |>
  group_by(Name) |>
  summarise(elevation = mean(elevation, na.rm = TRUE))
ggplot() +
  geom_sf(data = nz_agg)
```

```{r}
nearby_stations <- st_join(stats.DPC, stats.DPC, join = st_is_within_distance, dist = units::set_units(200, km))
nearby_stations |>
  group_by(station.x) |>
  summarise(count = n()) |>
  ggplot() +
  geom_sf(aes(color = count))
```

```{r}
library(stars)

elev <- read_stars(system.file("raster/elev.tif", package = "spData"))
grain <- read_stars(system.file("raster/grain.tif", package = "spData"))
```

```{r}
library(sf)
library(stars)
library(osmdata)
library(ggplot2)
source("load.R")

bg_poly <- getbb("Naples, Italy", format_out = "polygon")[1]
bg <- bg_poly |>
  st_polygon() |>
  st_sfc(crs = "WGS84")

dem <- load.DEM.COP30()
bg_dem <- dem[bg]
```

```{r}
ggplot() +
  geom_stars(data = bg_dem, downsample = 20)
```


```{r}
# library(dplyr)
library(terra)
# library(ggplot2)
source("load.R")
sea_src <- "/Users/davidenicoli/Local_Workspace/Datasets/COPERNICUS DEM30/Copernicus_DSM_10_N40_00_E016_00/DEM/Copernicus_DSM_10_N40_00_E016_00_DEM.tif"
adj1_src <- "/Users/davidenicoli/Local_Workspace/Datasets/COPERNICUS DEM30/Copernicus_DSM_10_N41_00_E016_00/DEM/Copernicus_DSM_10_N41_00_E016_00_DEM.tif"
adj2_src <- "/Users/davidenicoli/Local_Workspace/Datasets/COPERNICUS DEM30/Copernicus_DSM_10_N39_00_E016_00/DEM/Copernicus_DSM_10_N39_00_E016_00_DEM.tif"
adj3_src <- "/Users/davidenicoli/Local_Workspace/Datasets/COPERNICUS DEM30/Copernicus_DSM_10_N40_00_E017_00/DEM/Copernicus_DSM_10_N40_00_E017_00_DEM.tif"
```

```{r}
a <- rast(sea_src)
empty <- matrix(seq(1), ncol = 3601, nrow = 3601)
for (coord in missing_coords) {
  e <- align(ext(coord[1], coord[1] + 1, coord[2], coord[2] + 1), a, snap = "out")
  tile <- rast(empty, extent = e, crs = crs(a))
  writeRaster(tile, filename = paste0("missing_N", coord[2], "_E0", coord[1], "_WBM.tif"), datatype = "INT1U")
}
```

```{r}
for (x in 1:5) {
  print(x)
}
```


```{r}
geosphere::distGeo(c(0, 0), c(0, 1))
```


```{r}
library(sf)
library(ggplot2)
library(lubridate)
source("load.R")

sDPC <- load.DPC.T_MAX() |> filter(date > as.Date("2000-01-01"))
ydt <- group_by(sDPC, date) |> summarise(data_avail = n())
```

```{r}

```
